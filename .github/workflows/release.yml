name: Build and Release

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          pip install --upgrade pip
          pip install platformio

      - name: Build firmware и LittleFS образ
        run: |
          pio run -e esp32-s3-wroom-1-N16R8
          pio run -e esp32-s3-wroom-1-N16R8 -t buildfs

      - name: Извлечь версию из тега
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"                    # убираем ведущую 'v', если она есть
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT     # для отладки, если нужно

      - name: Проверить и подготовить файлы
        run: |
          SRC_DIR=".pio/build/esp32-s3-wroom-1-N16R8"
          
          ls -l "$SRC_DIR/firmware.bin" || { echo "Ошибка: firmware.bin не найден"; exit 1; }
          ls -l "$SRC_DIR/littlefs.bin" || { echo "Ошибка: littlefs.bin не найден — проверьте папку data/ и board_build.filesystem = littlefs в platformio.ini"; exit 1; }
          
          cp "$SRC_DIR/firmware.bin" firmware.bin
          cp "$SRC_DIR/littlefs.bin" littlefs.bin
          
          ls -l firmware.bin littlefs.bin

      - name: Создать manifest.json
        run: |
          cat > manifest.json << EOF
          {
            "type": "meteo_station",
            "version": "${{ steps.version.outputs.VERSION }}",
            "host": "tag78.ru",
            "port": 443,
            "bin": "/ota/meteo_station/firmware.bin",
            "littlefs": "/ota/meteo_station/littlefs.bin"
          }
          EOF

      - name: Загрузить артефакты
        uses: actions/upload-artifact@v4
        with:
          name: ota-files-${{ steps.version.outputs.VERSION }}
          path: |
            firmware.bin
            littlefs.bin
            manifest.json
          retention-days: 30

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Скачать артефакты
        uses: actions/download-artifact@v4
        with:
          name: ota-files-${{ needs.build.outputs.VERSION }}  # если не сработает — замени на steps.version.outputs.VERSION (см. примечание ниже)
          path: artifacts

      - name: Загрузка на сервер
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem

          ssh -i key.pem -o StrictHostKeyChecking=no \
            $SERVER_USER@$SERVER_HOST "mkdir -p /ota/meteo_station"

          scp -i key.pem -o StrictHostKeyChecking=no \
            artifacts/firmware.bin \
            artifacts/littlefs.bin \
            artifacts/manifest.json \
            $SERVER_USER@$SERVER_HOST:/ota/meteo_station/

          rm -f key.pem